<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devocional Familiar - Cuando el Cielo Ordena tus Letras</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&family=Lora:ital,wght@0,400;0,600;1,400&display=swap"
        rel="stylesheet">

    <!-- Custom Config & Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                        serif: ['Lora', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        /* Custom Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .animate-slide-in {
            animation: slideIn 0.5s ease-out forwards;
        }

        @keyframes pulse-custom {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        .animate-pulse-custom {
            animation: pulse-custom 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Audio Player floating styles */
        .audio-player-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 9999px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .audio-player-fab:hover {
            transform: scale(1.05);
            background: white;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen text-slate-800 flex flex-col">

    <!-- Background Audio -->
    <audio id="bgMusic" loop>
        <source src="https://pixabay.com/music/download/music-115367.mp3" type="audio/mp3">
        <!-- Alternative fallback or use a stable URL -->
    </audio>

    <div id="audio-control" class="audio-player-fab hidden cursor-pointer" onclick="toggleAudio()"
        title="M√∫sica de fondo">
        <i data-lucide="volume-2" id="volume-icon" class="w-5 h-5 text-indigo-600"></i>
    </div>

    <div id="app" class="flex-1 flex flex-col">
        <!-- Content will be injected here by JavaScript -->
    </div>

    <script>
        // --- DATA & CONFIG ---
        const BRAND_LOGO = "https://i.imgur.com/dDYOrEm.png";

        // Helper to render Brand Icon
        const getBrandIcon = (className = "h-5 w-auto") =>
            `<img src="${BRAND_LOGO}" alt="Logo" class="${className} object-contain">`;

        // State
        let currentStep = 0;
        let completed = false;
        let quizAnswer = null;
        let audioPlaying = false;

        // --- AUDIO LOGIC ---
        function initAudio() {
            const audio = document.getElementById('bgMusic');
            const btn = document.getElementById('audio-control');

            // Set volume low
            audio.volume = 0.3;

            // Try enabling audio context interaction
            if (!audioPlaying) {
                audio.play().then(() => {
                    audioPlaying = true;
                    btn.classList.remove('hidden');
                    updateAudioIcon();
                }).catch(e => {
                    // Browser blocked autoplay, wait for interaction
                    console.log("Audio autoplay blocked, waiting for interaction");
                    btn.classList.remove('hidden'); // Show button anyway so they can enable it
                    document.getElementById('volume-icon').setAttribute('data-lucide', 'volume-x');
                    lucide.createIcons();
                });
            }
        }

        function toggleAudio() {
            const audio = document.getElementById('bgMusic');
            if (audio.paused) {
                audio.play();
                audioPlaying = true;
            } else {
                audio.pause();
                audioPlaying = false;
            }
            updateAudioIcon();
        }

        function updateAudioIcon() {
            const icon = document.getElementById('volume-icon');
            const audio = document.getElementById('bgMusic');

            if (audio.paused) {
                icon.setAttribute('data-lucide', 'volume-x');
                icon.classList.add('text-gray-400');
                icon.classList.remove('text-indigo-600');
            } else {
                icon.setAttribute('data-lucide', 'volume-2');
                icon.classList.remove('text-gray-400');
                icon.classList.add('text-indigo-600');
            }
            lucide.createIcons();
        }

        function triggerConfetti() {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            var random = function (min, max) {
                return Math.random() * (max - min) + min;
            }

            var interval = setInterval(function () {
                var timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                var particleCount = 50 * (timeLeft / duration);
                // since particles fall down, start a bit higher than random
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        // --- CONTENT STEPS ---
        const steps = [
            {
                title: "Bienvenida",
                subtitle: "Portada del Devocional",
                isCover: true,
                renderContent: () => `
                    <div class="space-y-6 text-center animate-fade-in">
                        <div class="relative w-full rounded-3xl overflow-hidden shadow-2xl bg-slate-900 aspect-[4/5] md:aspect-video mb-6">
                            <img src="https://i.imgur.com/yrP3u2O.png" alt="Portada" class="w-full h-full object-cover">
                            
                            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-black/40"></div>
                            
                            <div class="absolute top-6 left-6">
                                <img src="${BRAND_LOGO}" alt="Logo Marca" class="h-10 w-auto object-contain brightness-0 invert opacity-90">
                            </div>

                            <div class="absolute bottom-8 left-0 right-0 px-8 text-left">
                                <span class="bg-indigo-600 text-white text-[10px] font-black px-3 py-1 rounded-full uppercase tracking-[0.2em] mb-3 inline-block shadow-lg">
                                    Plan Familiar Dominical
                                </span>
                                <h1 class="text-4xl md:text-5xl font-black text-white leading-[1.1] tracking-tight drop-shadow-2xl">
                                    Cuando el Cielo <br />
                                    <span class="text-indigo-400">Ordena tus Letras</span>
                                </h1>
                                <p class="text-white/90 text-sm font-medium mt-2 tracking-wide uppercase opacity-80">
                                    Tu intenci√≥n, Su traducci√≥n
                                </p>
                            </div>
                        </div>
                        
                        <div class="px-4 space-y-4">
                            <p class="text-gray-500 font-medium italic text-lg leading-relaxed">
                                "Un tiempo para reconocer que Dios escucha incluso nuestros pensamientos m√°s sencillos."
                            </p>
                            <div class="flex justify-center gap-1.5 text-amber-400">
                                <i data-lucide="star" class="w-5 h-5 fill-current"></i>
                                <i data-lucide="star" class="w-5 h-5 fill-current"></i>
                                <i data-lucide="star" class="w-5 h-5 fill-current"></i>
                                <i data-lucide="star" class="w-5 h-5 fill-current"></i>
                                <i data-lucide="star" class="w-5 h-5 fill-current"></i>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                title: "Introducci√≥n",
                subtitle: "La amnesia y la an√©cdota",
                renderContent: () => `
                    <div class="space-y-4 animate-fade-in">
                        <div class="relative w-full rounded-2xl overflow-hidden shadow-md bg-slate-100 mb-6 border border-gray-100">
                            <video src="https://i.imgur.com/bW3e1SV.mp4" autoplay loop muted playsinline class="w-full h-auto object-cover max-h-[250px]"></video>
                            <div class="absolute bottom-2 right-2 bg-black/30 backdrop-blur-sm px-2 py-1 rounded text-[10px] text-white/80">
                                Reflexi√≥n
                            </div>
                        </div>

                        <p class="text-gray-700 leading-relaxed">
                            A veces sufrimos de una <strong>"amnesia espiritual"</strong>. Pedimos milagros, pero apenas los recibimos, olvidamos qui√©n nos los dio y qui√©nes somos en √âl.
                        </p>
                        <p class="text-gray-700">
                            Pero hay algo que me niego a olvidar. ¬øRecuerdan la Navidad pasada? Regalamos zapatos y un bal√≥n al hijo de nuestro compa√±ero. Pensamos: "Misi√≥n cumplida".
                        </p>
                        <p class="text-gray-700 mb-2">
                            Sin embargo, √©l respondi√≥ con una carta que me desarm√≥:
                        </p>
                        
                        <div class="bg-amber-50 p-6 rounded-2xl shadow-sm border border-amber-100 relative group">
                            <button onclick="shareVerse('Sobre toda cosa guardada, guarda tu coraz√≥n; porque de √©l mana la vida.', 'Proverbios 4:23')" class="absolute top-4 right-4 p-2 bg-white hover:bg-white rounded-full text-amber-900 transition-all shadow-sm z-10" title="Compartir Perla">
                                <i data-lucide="share-2" class="w-4 h-4"></i>
                            </button>
                            <h4 class="font-bold text-amber-800 mb-2 flex items-center gap-2">
                                <i data-lucide="book-open" class="w-5 h-5"></i> Proverbios 4:23
                            </h4>
                            <p class="text-lg text-amber-900 font-serif italic">
                                "Sobre toda cosa guardada, guarda tu coraz√≥n; porque de √©l mana la vida."
                            </p>
                        </div>
                        <p class="text-sm text-gray-500 italic mt-2 text-center">
                            √âl entendi√≥ que el verdadero regalo no estaba en la caja, sino en la intenci√≥n.
                        </p>
                    </div>
                `
            },
            {
                title: "El Principio",
                subtitle: "Todo para Su Gloria",
                renderContent: () => `
                    <div class="space-y-4 animate-fade-in">
                        <p class="text-gray-700">
                            ¬øPor qu√© hacemos lo que hacemos? A veces nos complicamos pensando si nuestra ofrenda es perfecta. Pero Pablo nos da la clave:
                        </p>
                        <div class="bg-indigo-600 p-6 rounded-2xl text-white shadow-lg relative group">
                             <button onclick="shareVerse('Si, pues, com√©is o beb√©is, o hac√©is otra cosa, hacedlo todo para la gloria de Dios.', '1 Corintios 10:31')" class="absolute top-4 right-4 p-2 bg-white/20 hover:bg-white/40 rounded-full text-white transition-all shadow-sm z-10" title="Compartir Perla">
                                <i data-lucide="share-2" class="w-4 h-4"></i>
                            </button>
                            <h4 class="font-bold mb-2 flex items-center gap-2">
                                ${getBrandIcon("h-4 brightness-0 invert")} 1 Corintios 10:31
                            </h4>
                            <p class="text-xl font-medium">
                                "Si, pues, com√©is o beb√©is, o hac√©is otra cosa, hacedlo todo para la gloria de Dios."
                            </p>
                        </div>
                        
                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mt-4">
                            <h5 class="font-bold text-indigo-800 mb-2 flex items-center gap-2">
                                <i data-lucide="message-circle" class="w-4 h-4"></i> Pregunta para la familia:
                            </h5>
                            <p class="text-indigo-900 italic text-sm">
                                "¬øEn qu√© peque√±a cosa de ma√±ana lunes podr√≠as aplicar esto de 'hacerlo para Dios'?"
                            </p>
                        </div>
                    </div>
                `
            },
            {
                title: "El Cl√≠max",
                subtitle: "El Alfabeto de Dios",
                renderContent: () => `
                    <div class="space-y-4 animate-fade-in">
                        <p class="text-gray-700">
                            Una ni√±a decidi√≥ orar y sus padres la escucharon decir: <em>"A, B, C, D..."</em>. Al preguntarle, ella respondi√≥ con sabidur√≠a profunda:
                        </p>
                        <div class="bg-emerald-50 p-6 rounded-2xl border-2 border-dashed border-emerald-200 text-emerald-900 font-medium text-lg text-center relative group">
                             <button onclick="shareVerse('Yo ac√° digo las letras y all√° en el cielo Dios arma las palabras.', 'An√©cdota de Fe')" class="absolute top-2 right-2 p-2 bg-white/50 hover:bg-emerald-100 rounded-full text-emerald-900 transition-all shadow-sm z-10" title="Compartir Perla">
                                <i data-lucide="share-2" class="w-4 h-4"></i>
                            </button>
                            "Yo tengo tanta fe, que s√© que yo ac√° digo las letras y all√° en el cielo Dios arma las palabras."
                        </div>
                        
                        <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm mt-4">
                             <h4 class="font-bold text-gray-800 mb-2 flex items-center gap-2 text-sm uppercase tracking-wide">
                                <i data-lucide="zap" class="w-4 h-4 text-amber-500"></i> Transformaci√≥n
                            </h4>
                            <p class="text-gray-600 mb-2">
                                <strong>Romanos 12:2</strong> nos llama a ser transformados por la renovaci√≥n de nuestro entendimiento.
                            </p>
                            <p class="text-indigo-600 font-bold text-center">
                                T√∫ pones la intenci√≥n (las letras), √âl pone la transformaci√≥n (las palabras).
                            </p>
                        </div>
                    </div>
                `
            },
            {
                title: "Repaso",
                subtitle: "¬øEntendimos la lecci√≥n?",
                renderContent: () => {
                    const options = [
                        { id: 'a', text: "Repetir el abecedario es la √∫nica forma de orar.", correct: false },
                        { id: 'b', text: "Que Dios conoce nuestra intenci√≥n y √âl ordena nuestra oraci√≥n.", correct: true },
                        { id: 'c', text: "Que debemos hablar con palabras perfectas.", correct: false }
                    ];

                    let quizHtml = `
                    <div class="space-y-6 animate-fade-in">
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                            <h4 class="font-bold text-slate-800 text-lg mb-4 flex items-center gap-2">
                                <i data-lucide="help-circle" class="text-indigo-500 w-5 h-5"></i>
                                ¬øQu√© nos ense√±a la historia de la ni√±a?
                            </h4>
                            <div class="space-y-3">
                    `;

                    options.forEach(opt => {
                        let btnClass = "w-full p-4 rounded-xl text-left font-medium transition-all border-2 flex items-center justify-between ";
                        let icon = "";

                        if (quizAnswer === opt.id) {
                            if (opt.correct) {
                                btnClass += "border-emerald-500 bg-emerald-50 text-emerald-900";
                                icon = `<i data-lucide="check-circle" class="w-5 h-5"></i>`;
                            } else {
                                btnClass += "border-rose-500 bg-rose-50 text-rose-900";
                                icon = "<span>‚úï</span>";
                            }
                        } else {
                            btnClass += "border-white bg-white hover:border-indigo-100 shadow-sm";
                        }

                        quizHtml += `
                            <button onclick="handleQuiz('${opt.id}')" class="${btnClass}">
                                <span>${opt.text}</span>
                                ${icon}
                            </button>
                        `;
                    });

                    quizHtml += `</div></div>`;

                    if (quizAnswer) {
                        const isCorrect = options.find(o => o.id === quizAnswer).correct;
                        const feedbackClass = isCorrect ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800';
                        const feedbackIcon = isCorrect ? 'award' : 'help-circle';
                        const feedbackText = isCorrect
                            ? "¬°Am√©n! Dios es el gran traductor de nuestros corazones."
                            : "Intenta de nuevo. Recuerda que la ni√±a confiaba en lo que Dios har√≠a con sus letras.";

                        quizHtml += `
                            <div class="${feedbackClass} p-4 rounded-xl flex items-start gap-3 animate-fade-in">
                                <div class="mt-1"><i data-lucide="${feedbackIcon}" class="w-5 h-5"></i></div>
                                <p class="text-sm">${feedbackText}</p>
                            </div>
                        `;
                    }

                    quizHtml += `</div>`;
                    return quizHtml;
                }
            },
            {
                title: "Reflexi√≥n",
                subtitle: "Reflexi√≥n y Acci√≥n",
                renderContent: () => `
                    <div class="space-y-6 animate-fade-in">
                        <p class="text-gray-700">
                            No nos vayamos tras este devocional con amnesia. Recordemos dos cosas fundamentales para accionar esta semana:
                        </p>
                        
                        <div class="space-y-4">
                            <!-- Point 1 -->
                            <div class="bg-white p-5 rounded-2xl border-l-4 border-blue-500 shadow-sm">
                                <h4 class="font-bold text-blue-800 mb-1">1. No te olvides de DAR</h4>
                                <p class="text-sm text-gray-500 mb-2">Hebreos 13:16</p>
                                <p class="text-gray-700 italic">
                                    "Y de hacer bien y de la ayuda mutua no os olvid√©is; porque de tales sacrificios se agrada Dios".
                                </p>
                            </div>

                            <!-- Point 2 -->
                            <div class="bg-white p-5 rounded-2xl border-l-4 border-purple-500 shadow-sm">
                                <h4 class="font-bold text-purple-800 mb-1">2. No te olvides de AGRADECER</h4>
                                <p class="text-sm text-gray-500 mb-2">Salmos 103:2</p>
                                <p class="text-gray-700 italic">
                                    "Bendice, alma m√≠a, a Jehov√°, Y no olvides ninguno de sus beneficios".
                                </p>
                            </div>
                        </div>
                        <p class="text-center font-semibold text-gray-800">
                            Recordar lo que Dios ha hecho desata la adoraci√≥n.
                        </p>
                    </div>
                `
            },
            {
                title: "Oraci√≥n",
                subtitle: "Oraci√≥n Guiada",
                renderContent: () => `
                    <div class="space-y-6 animate-fade-in">
                        <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-6 rounded-3xl text-white shadow-xl">
                            <h3 class="font-bold text-lg mb-4 text-center border-b border-white/20 pb-2">Dale tus letras a Dios</h3>
                            
                            <div class="space-y-6">
                                <div>
                                    <span class="bg-white/20 text-xs font-bold px-2 py-1 rounded uppercase tracking-wider">Paso 1: Gratitud</span>
                                    <p class="mt-2 text-indigo-50 italic">
                                        "Se√±or, no quiero olvidar tus beneficios. Gracias por lo que has hecho en mi vida."
                                    </p>
                                    <p class="text-xs mt-1 text-white/60">(Toma un momento en silencio)</p>
                                </div>

                                <div>
                                    <span class="bg-white/20 text-xs font-bold px-2 py-1 rounded uppercase tracking-wider">Paso 2: Intenci√≥n</span>
                                    <p class="mt-2 text-indigo-50 italic">
                                        "Tal vez no tengo palabras perfectas, pero te entrego mi coraz√≥n. Arma T√∫ las palabras que necesito. Transf√≥rmame de adentro hacia afuera."
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-amber-50 p-6 rounded-2xl border border-amber-200">
                            <p class="text-amber-900 italic text-center leading-relaxed font-serif">
                                "Padre, gracias porque T√∫ eres el gran traductor de nuestros corazones. Ens√©√±anos a vivir para agradarte. Am√©n."
                            </p>
                        </div>
                        
                         <div class="text-center text-gray-500 text-sm italic mt-4">
                            Contin√∫a para la actividad final...
                        </div>
                    </div>
                `
            },
            {
                title: "Para no olvidar",
                subtitle: "Sopa de Letras",
                renderContent: () => `
                    <div class="space-y-4 animate-fade-in select-none">
                        <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-4">
                            <p class="text-indigo-800 text-sm text-center font-medium">
                                Para que estas verdades queden en tu mente, encuentra las palabras clave de hoy.<br>
                            </p>
                        </div>

                        <!-- Grid Container -->
                        <div id="ws-grid" class="grid gap-1 mx-auto max-w-[350px] touch-none" style="grid-template-columns: repeat(9, 1fr);" ontouchmove="handleTouchMove(event)">
                            <!-- JS Injected -->
                        </div>

                        <!-- Word List -->
                        <div id="ws-words" class="flex flex-wrap justify-center gap-2 mt-6">
                            <!-- JS Injected -->
                        </div>

                        <!-- Success Message & Finish -->
                        <div id="ws-message" class="hidden mt-6 space-y-4 animate-fade-in">
                            <div class="bg-emerald-100 text-emerald-800 p-4 rounded-xl text-center font-bold flex items-center justify-center gap-2">
                                <i data-lucide="trophy" class="w-5 h-5"></i> ¬°Excelente!
                            </div>
                            <button onclick="finishDevotional()" 
                                class="w-full py-4 bg-emerald-600 text-white font-bold rounded-2xl hover:bg-emerald-700 transition-colors shadow-lg flex items-center justify-center gap-2 hover:scale-[1.02] active:scale-95 transform animate-pulse-custom">
                                <i data-lucide="check-circle" class="w-5 h-5"></i> Finalizar Devocional
                            </button>
                        </div>
                    </div>
                `,
                mount: () => {
                    initWordSearch();
                    renderWordSearchGrid();
                    // Add global listener for mouse up to end selection anywhere
                    document.addEventListener('mouseup', handleGlobalEnd);
                    document.addEventListener('touchend', handleGlobalEnd);
                },
                unmount: () => {
                    document.removeEventListener('mouseup', handleGlobalEnd);
                    document.removeEventListener('touchend', handleGlobalEnd);
                }
            }
        ];

        function shareVerse(text, reference) {
            const shareData = {
                title: 'Perla del Devocional Familiar',
                text: `"${text}" - ${reference}\n\nLe√≠do en nuestro Devocional Familiar de hoy ‚ú®`,
                url: window.location.href
            };

            if (navigator.share) {
                navigator.share(shareData)
                    .catch((err) => console.log('Error sharing:', err));
            } else {
                // Fallback to WhatsApp
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareData.text)}`;
                window.open(whatsappUrl, '_blank');
            }
        }


        // --- ACTIONS ---

        function render() {
            const app = document.getElementById('app');
            const step = steps[currentStep];
            const progress = ((currentStep + 1) / steps.length) * 100;

            // 1. Render Completed Screen
            if (completed) {
                app.innerHTML = `
                    <div class="min-h-screen bg-slate-50 flex items-center justify-center p-6 font-sans text-slate-800">
                        <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl p-10 text-center space-y-6 border border-gray-100 animate-fade-in">
                            <div class="w-24 h-24 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-white shadow-xl">
                                ${getBrandIcon("h-12 w-auto animate-pulse-custom")}
                            </div>
                            <h1 class="text-3xl font-extrabold text-gray-900">¬°Gloria a Dios!</h1>
                            <p class="text-gray-600 text-lg">Has completado el devocional de hoy. Que estas verdades guarden tu coraz√≥n.</p>
                            <button onclick="restart()" class="px-8 py-3 bg-gray-900 text-white rounded-full font-bold hover:bg-gray-800 transition-all shadow-lg hover:scale-105 active:scale-95">
                                Volver a empezar
                            </button>
                        </div>
                    </div>
                `;
                triggerConfetti(); // üéâ FIREWORKS!
            } else {
                // 2. Render Normal Step
                let headerHtml = '';
                if (!step.isCover) {
                    headerHtml = `
                        <header class="bg-white border-b border-gray-100 px-6 py-4 sticky top-0 z-10 shadow-sm">
                            <div class="max-w-2xl mx-auto flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <img src="${BRAND_LOGO}" alt="Logo" class="h-8 w-auto object-contain">
                                    <div class="h-6 w-px bg-gray-200 mx-1 hidden sm:block"></div>
                                    <div>
                                        <h1 class="text-[10px] font-black text-indigo-500 uppercase tracking-widest">Devocional Familiar</h1>
                                        <p class="text-sm font-bold text-slate-800 truncate max-w-[150px] sm:max-w-none">${step.title}</p>
                                    </div>
                                </div>
                                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-md border border-gray-50 overflow-hidden p-1.5 transition-transform hover:scale-110">
                                    ${getBrandIcon("h-full w-auto")}
                                </div>
                            </div>
                            <div class="max-w-2xl mx-auto mt-4 h-1 w-full bg-gray-100 rounded-full overflow-hidden">
                                <div class="h-full bg-indigo-500 transition-all duration-500 ease-out" style="width: ${progress}%"></div>
                            </div>
                        </header>
                    `;
                }

                let contentHeader = '';
                if (!step.isCover) {
                    contentHeader = `
                        <div class="mb-8">
                            <span class="text-indigo-500 font-bold text-sm uppercase tracking-widest">Secci√≥n ${currentStep}</span>
                            <h2 class="text-3xl font-black text-gray-900 mt-1">${step.subtitle}</h2>
                        </div>
                    `;
                }

                // Buttons logic
                let prevButton = currentStep > 0 ? `
                    <button onclick="changeStep(-1)" class="flex-1 py-4 bg-gray-100 text-gray-600 rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-gray-200 transition-colors active:scale-95">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i> Anterior
                    </button>
                ` : '';

                let nextButtonText = currentStep === 0 ? 'Empezar Devocional' : 'Siguiente';
                let nextButton = currentStep < steps.length - 1 ? `
                    <button onclick="changeStep(1)" class="flex-[2] py-4 bg-indigo-600 text-white rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-indigo-700 shadow-lg transition-transform active:scale-95">
                         ${nextButtonText} <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                ` : '';

                let footerHtml = `
                    <footer class="bg-white border-t border-gray-100 p-6 mt-auto">
                        <div class="max-w-2xl mx-auto flex gap-4">
                            ${prevButton}
                            ${nextButton}
                        </div>
                    </footer>
                `;

                app.innerHTML = `
                    ${headerHtml}
                    <main class="flex-1 overflow-y-auto px-6 py-8">
                        <div class="max-w-2xl mx-auto bg-white rounded-3xl shadow-sm border border-gray-100 p-6 md:p-10 min-h-[500px] flex flex-col ${step.isCover ? 'justify-center' : ''}">
                            ${contentHeader}
                            <div class="flex-1">
                                ${step.renderContent()}
                            </div>
                        </div>
                    </main>
                    ${footerHtml}
                `;

                // Executes mount if available for the step
                if (step.mount) {
                    setTimeout(() => step.mount(), 50);
                }
            }

            // Initialize Icons
            lucide.createIcons();

            // Scroll top
            window.scrollTo(0, 0);
        }

        function changeStep(direction) {

            // Unmount previous step
            const currentStepObj = steps[currentStep];
            if (currentStepObj.unmount) {
                currentStepObj.unmount();
            }

            // Try enabling audio on first interaction
            if (!audioPlaying) {
                initAudio();
            }

            const newStep = currentStep + direction;
            if (newStep >= 0 && newStep < steps.length) {
                currentStep = newStep;
                quizAnswer = null; // Reset quiz on step change
                render();
            }
        }

        function handleQuiz(optionId) {
            quizAnswer = optionId;
            render(); // Re-render to show feedback/styles
        }

        // --- WORD SEARCH GAME LOGIC ---
        const WORD_SEARCH_DATA = {
            gridSize: 9,
            words: ["CORAZON", "GLORIA", "AMNESIA", "LETRAS", "FE", "DIOS", "ORACION", "ALMA"],
            grid: [],
            foundWords: [],
            foundCells: new Set(), // Set of "r,c" strings
            selectionStart: null,
            selectionEnd: null,
            isSelecting: false
        };

        function initWordSearch() {
            // Generate Grid
            const size = WORD_SEARCH_DATA.gridSize;
            const grid = Array(size).fill(null).map(() => Array(size).fill(''));
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

            // Place words
            WORD_SEARCH_DATA.words.forEach(word => {
                let placed = false;
                let attempts = 0;
                while (!placed && attempts < 100) {
                    const direction = Math.random() > 0.5 ? 'H' : 'V'; // H or V
                    const row = Math.floor(Math.random() * size);
                    const col = Math.floor(Math.random() * size);

                    if (canPlaceWord(grid, word, row, col, direction)) {
                        placeWord(grid, word, row, col, direction);
                        placed = true;
                    }
                    attempts++;
                }
            });

            // Fill empty
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    if (grid[i][j] === '') {
                        grid[i][j] = letters.charAt(Math.floor(Math.random() * letters.length));
                    }
                }
            }
            WORD_SEARCH_DATA.grid = grid;
            WORD_SEARCH_DATA.foundWords = [];
            WORD_SEARCH_DATA.foundCells = new Set();
        }

        function canPlaceWord(grid, word, row, col, direction) {
            if (direction === 'H') {
                if (col + word.length > grid.length) return false;
                for (let i = 0; i < word.length; i++) {
                    if (grid[row][col + i] !== '' && grid[row][col + i] !== word[i]) return false;
                }
            } else {
                if (row + word.length > grid.length) return false;
                for (let i = 0; i < word.length; i++) {
                    if (grid[row + i][col] !== '' && grid[row + i][col] !== word[i]) return false;
                }
            }
            return true;
        }

        function placeWord(grid, word, row, col, direction) {
            for (let i = 0; i < word.length; i++) {
                if (direction === 'H') grid[row][col + i] = word[i];
                else grid[row + i][col] = word[i];
            }
        }

        function renderWordSearchGrid() {
            const container = document.getElementById('ws-grid');
            if (!container) return;

            container.innerHTML = '';
            container.style.gridTemplateColumns = `repeat(${WORD_SEARCH_DATA.gridSize}, 1fr)`;

            WORD_SEARCH_DATA.grid.forEach((row, rIndex) => {
                row.forEach((char, cIndex) => {
                    const cell = document.createElement('div');
                    cell.innerText = char;
                    cell.className = `aspect-square flex items-center justify-center font-bold text-sm md:text-lg select-none cursor-pointer rounded-md transition-colors ${getCellClass(rIndex, cIndex)}`;
                    cell.dataset.row = rIndex;
                    cell.dataset.col = cIndex;

                    // Events
                    cell.onmousedown = (e) => startSelection(rIndex, cIndex, e);
                    cell.onmouseover = () => updateSelection(rIndex, cIndex);
                    cell.onmouseup = (e) => endSelection(e);
                    cell.ontouchstart = (e) => { e.preventDefault(); startSelection(rIndex, cIndex); }; // Prevent scroll

                    container.appendChild(cell);
                });
            });

            // Update Word List
            const listContainer = document.getElementById('ws-words');
            if (listContainer) {
                listContainer.innerHTML = WORD_SEARCH_DATA.words.map(w =>
                    `<span class="px-2 py-1 rounded ${WORD_SEARCH_DATA.foundWords.includes(w) ? 'line-through text-gray-400 bg-gray-100' : 'text-indigo-900 bg-indigo-50 font-semibold'} text-xs md:text-sm transition-all">${w}</span>`
                ).join('');
            }

            // Check win
            if (WORD_SEARCH_DATA.foundWords.length === WORD_SEARCH_DATA.words.length) {
                document.getElementById('ws-message').classList.remove('hidden');
                triggerConfetti();
            }
        }

        function getCellClass(r, c) {
            if (WORD_SEARCH_DATA.foundCells.has(`${r},${c}`)) {
                return 'found-cell bg-emerald-200 text-emerald-900 border-emerald-300';
            }
            return 'bg-white border border-slate-100 text-slate-700 hover:bg-slate-50';
        }

        // Interaction Logic
        function startSelection(r, c, e) {
            WORD_SEARCH_DATA.isSelecting = true;
            WORD_SEARCH_DATA.selectionStart = { r, c };
            WORD_SEARCH_DATA.selectionEnd = { r, c };
            highlightGrid();
        }

        function updateSelection(r, c) {
            if (!WORD_SEARCH_DATA.isSelecting) return;
            WORD_SEARCH_DATA.selectionEnd = { r, c };
            highlightGrid();
        }

        function endSelection(e) {
            if (!WORD_SEARCH_DATA.isSelecting) return;

            // Try to update selection one last time if it's a touch event
            if (e && e.changedTouches && e.changedTouches.length > 0) {
                const touch = e.changedTouches[0];
                const el = document.elementFromPoint(touch.clientX, touch.clientY);
                if (el) {
                    const cell = el.closest('[data-row]');
                    if (cell) {
                        updateSelection(parseInt(cell.dataset.row), parseInt(cell.dataset.col));
                    }
                }
            }

            WORD_SEARCH_DATA.isSelecting = false;
            checkWord();
            WORD_SEARCH_DATA.selectionStart = null;
            WORD_SEARCH_DATA.selectionEnd = null;
            highlightGrid();
        }

        // Global touch move handler for the grid
        function handleTouchMove(e) {
            if (!WORD_SEARCH_DATA.isSelecting) return;
            e.preventDefault();
            const touch = e.touches[0];
            const el = document.elementFromPoint(touch.clientX, touch.clientY);
            if (el) {
                const cell = el.closest('[data-row]');
                if (cell) {
                    updateSelection(parseInt(cell.dataset.row), parseInt(cell.dataset.col));
                }
            }
        }

        function highlightGrid() {
            // Clear temporary highlights (but keep found ones)
            const cells = document.querySelectorAll('#ws-grid > div');
            cells.forEach(cell => {
                const r = parseInt(cell.dataset.row);
                const c = parseInt(cell.dataset.col);

                // Reset to base state from visual update
                // Note: The classes are re-applied based on standard logic, we just modify ON TOP of that potential base
                // But simplified: reset to what getCellClass returns + highlight if needed

                const baseClass = `aspect-square flex items-center justify-center font-bold text-sm md:text-lg select-none cursor-pointer rounded-md transition-colors ${getCellClass(r, c)}`;
                cell.className = baseClass;

                if (WORD_SEARCH_DATA.isSelecting && WORD_SEARCH_DATA.selectionStart) {
                    if (isLine(WORD_SEARCH_DATA.selectionStart, WORD_SEARCH_DATA.selectionEnd, r, c)) {
                        cell.classList.remove('bg-white', 'text-slate-700', 'bg-emerald-200', 'text-emerald-900');
                        cell.classList.add('bg-indigo-300', 'text-indigo-900', 'scale-105');
                    }
                }
            });
        }

        function isLine(start, end, r, c) {
            // Check if (r,c) is on the line between start and end
            // Support Horizontal, Vertical, Diagonal
            const dr = end.r - start.r;
            const dc = end.c - start.c;

            // Check if valid direction
            if (dr === 0 && dc === 0) return r === start.r && c === start.c;

            // Normalize direction
            const stepR = dr === 0 ? 0 : dr / Math.abs(dr);
            const stepC = dc === 0 ? 0 : dc / Math.abs(dc);

            // Diagonal check: must be 45 degrees
            if (stepR !== 0 && stepC !== 0 && Math.abs(dr) !== Math.abs(dc)) return false;

            // Check if point is on the segment
            // (r - start.r) should be multiple of stepR
            const distR = r - start.r;
            const distC = c - start.c;

            if (stepR !== 0 && (distR % stepR !== 0)) return false;
            if (stepC !== 0 && (distC % stepC !== 0)) return false;

            // Check bounds
            // Is it between start and end?
            // Simple approach: Iterate from start to end and match
            let currR = start.r;
            let currC = start.c;
            // Limit loop to avoid crash
            for (let i = 0; i < 20; i++) {
                if (currR === r && currC === c) return true;
                if (currR === end.r && currC === end.c) break;
                currR += stepR;
                currC += stepC;
            }
            return false;
        }

        function checkWord() {
            const start = WORD_SEARCH_DATA.selectionStart;
            const end = WORD_SEARCH_DATA.selectionEnd;
            if (!start || !end) return;

            // Extract word
            const dr = end.r - start.r;
            const dc = end.c - start.c;

            // Normalize direction
            const stepR = dr === 0 ? 0 : dr / Math.abs(dr);
            const stepC = dc === 0 ? 0 : dc / Math.abs(dc);

            // Diagonal check
            if (stepR !== 0 && stepC !== 0 && Math.abs(dr) !== Math.abs(dc)) return;

            let word = "";
            let path = [];
            let currR = start.r;
            let currC = start.c;

            for (let i = 0; i < 20; i++) {
                word += WORD_SEARCH_DATA.grid[currR][currC];
                path.push({ r: currR, c: currC });
                if (currR === end.r && currC === end.c) break;
                currR += stepR;
                currC += stepC;
            }

            // Check normal and reverse
            const reverseWord = word.split('').reverse().join('');

            const found = WORD_SEARCH_DATA.words.includes(word) ? word : (WORD_SEARCH_DATA.words.includes(reverseWord) ? reverseWord : null);

            if (found && !WORD_SEARCH_DATA.foundWords.includes(found)) {
                WORD_SEARCH_DATA.foundWords.push(found);

                // Add to found cells
                path.forEach(p => {
                    WORD_SEARCH_DATA.foundCells.add(`${p.r},${p.c}`);
                });

                renderWordSearchGrid(); // Re-render to show persistent styles
            }
        }


        // Global handler for cleanup
        function handleGlobalEnd(e) {
            endSelection(e);
        }

        function finishDevotional() {
            completed = true;
            render();
        }

        function restart() {
            currentStep = 0;
            completed = false;
            quizAnswer = null;
            render();
        }

        // --- INIT ---
        render();

    </script>
</body>

</html>
